{
  "session_id": "d4b7f69e43e04000",
  "admin_id": 1,
  "step_name": "sql_generation",
  "status": "success",
  "error_message": null,
  "timestamp": "2026-02-13T11:37:05",
  "input": {
    "rewritten_query": "查询本周学生出勤异常情况",
    "parse_result": {
      "intent": "business_query",
      "entities": [],
      "dimensions": [
        "student.student_no",
        "student.real_name",
        "course.course_name",
        "attendance.status"
      ],
      "metrics": [],
      "filters": [
        {
          "field": "attendance.status",
          "op": "in",
          "value": [
            "缺勤",
            "迟到",
            "早退",
            "请假未批",
            "旷课"
          ]
        },
        {
          "field": "attendance.attend_date",
          "op": ">=",
          "value": "2024-06-10"
        },
        {
          "field": "attendance.attend_date",
          "op": "<=",
          "value": "2024-06-16"
        }
      ],
      "time_range": {
        "start": "2024-06-10",
        "end": "2024-06-16"
      },
      "operation": "detail",
      "confidence": 0.95
    },
    "hidden_context_result": {
      "error_type": "execution_error",
      "error": "",
      "failed_sql": "WITH base AS (SELECT student.student_no, student.real_name, course.course_name, attendance.status FROM student JOIN enroll ON student.id = enroll.student_id JOIN course_class ON enroll.course_class_id = course_class.id JOIN course ON course_class.course_id = course.id JOIN attendance ON student.id = attendance.student_id AND course_class.id = attendance.course_class_id WHERE attendance.status IN ('缺勤', '迟到', '早退', '请假未批', '旷课') AND attendance.attend_date >= '2024-06-10' AND attendance.attend_date <= '2024-06-16' AND student.is_deleted = 0 AND enroll.is_deleted = 0 AND course_class.is_deleted = 0 AND course.is_deleted = 0 AND attendance.is_deleted = 0) SELECT base.student_no, base.real_name, base.course_name, base.status FROM base GROUP BY base.student_no, base.real_name, base.course_name, base.status",
      "rewritten_query": "查询本周学生出勤异常情况",
      "field_candidates": [],
      "probe_samples": [
        {
          "field": "student.student_no",
          "probe_sql": "SELECT DISTINCT student.student_no AS value FROM student WHERE student.student_no IS NOT NULL AND student.is_deleted = 0 LIMIT 20",
          "values": [
            "S00001",
            "S00002",
            "S00003",
            "S00004",
            "S00005",
            "S00006",
            "S00007",
            "S00008",
            "S00009",
            "S00010",
            "S00011",
            "S00012",
            "S00013",
            "S00014",
            "S00015",
            "S00016",
            "S00017",
            "S00018",
            "S00019",
            "S00020"
          ]
        },
        {
          "field": "student.real_name",
          "probe_sql": "SELECT DISTINCT student.real_name AS value FROM student WHERE student.real_name IS NOT NULL AND student.is_deleted = 0 LIMIT 20",
          "values": [
            "施伟",
            "Ethan",
            "周鹏",
            "孔航",
            "吴斌",
            "沈强博",
            "Isabella",
            "孙芳",
            "钱丹",
            "施斌",
            "周欣",
            "Olivia",
            "沈燕",
            "郑涛宇",
            "吕斌",
            "陶洋",
            "何勇",
            "姜萍",
            "冯峰",
            "郑航"
          ]
        },
        {
          "field": "course.course_name",
          "probe_sql": "SELECT DISTINCT course.course_name AS value FROM course WHERE course.course_name IS NOT NULL AND course.is_deleted = 0 LIMIT 20",
          "values": [
            "设计学院课程1",
            "工程学院课程2",
            "工程学院课程3",
            "学理学院课程4",
            "制造学院课程5",
            "制造学院课程6",
            "制造学院课程7",
            "管理学院课程8",
            "管理学院课程9",
            "管理学院课程10",
            "设计学院课程11",
            "贸易学院课程12",
            "人文学院课程13",
            "制造学院课程14",
            "国语学院课程15",
            "人文学院课程16",
            "人文学院课程17",
            "国语学院课程18",
            "管理学院课程19",
            "学理学院课程20"
          ]
        },
        {
          "field": "attendance.status",
          "probe_sql": "SELECT DISTINCT attendance.status AS value FROM attendance WHERE attendance.status IS NOT NULL AND attendance.is_deleted = 0 LIMIT 20",
          "values": [
            "缺勤",
            "迟到",
            "早退",
            "出勤"
          ]
        },
        {
          "field": "student.id",
          "probe_sql": "SELECT DISTINCT student.id AS value FROM student WHERE student.id IS NOT NULL AND student.is_deleted = 0 LIMIT 20",
          "values": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "20"
          ]
        },
        {
          "field": "enroll.student_id",
          "probe_sql": "SELECT DISTINCT enroll.student_id AS value FROM enroll WHERE enroll.student_id IS NOT NULL AND enroll.is_deleted = 0 LIMIT 20",
          "values": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "20"
          ]
        },
        {
          "field": "enroll.course_class_id",
          "probe_sql": "SELECT DISTINCT enroll.course_class_id AS value FROM enroll WHERE enroll.course_class_id IS NOT NULL AND enroll.is_deleted = 0 LIMIT 20",
          "values": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "20"
          ]
        },
        {
          "field": "course_class.id",
          "probe_sql": "SELECT DISTINCT course_class.id AS value FROM course_class WHERE course_class.id IS NOT NULL AND course_class.is_deleted = 0 LIMIT 20",
          "values": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "20"
          ]
        },
        {
          "field": "course_class.course_id",
          "probe_sql": "SELECT DISTINCT course_class.course_id AS value FROM course_class WHERE course_class.course_id IS NOT NULL AND course_class.is_deleted = 0 LIMIT 20",
          "values": [
            "163",
            "210",
            "167",
            "263",
            "121",
            "217",
            "70",
            "45",
            "83",
            "150",
            "133",
            "60",
            "118",
            "2",
            "38",
            "204",
            "178",
            "107",
            "183",
            "223"
          ]
        },
        {
          "field": "course.id",
          "probe_sql": "SELECT DISTINCT course.id AS value FROM course WHERE course.id IS NOT NULL AND course.is_deleted = 0 LIMIT 20",
          "values": [
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19",
            "20"
          ]
        },
        {
          "field": "attendance.student_id",
          "probe_sql": "SELECT DISTINCT attendance.student_id AS value FROM attendance WHERE attendance.student_id IS NOT NULL AND attendance.is_deleted = 0 LIMIT 20",
          "values": [
            "8619",
            "11730",
            "5257",
            "16266",
            "15752",
            "91",
            "2918",
            "18815",
            "2953",
            "3321",
            "7576",
            "8656",
            "3272",
            "1294",
            "10248",
            "3799",
            "1505",
            "4536",
            "11717",
            "8793"
          ]
        },
        {
          "field": "attendance.course_class_id",
          "probe_sql": "SELECT DISTINCT attendance.course_class_id AS value FROM attendance WHERE attendance.course_class_id IS NOT NULL AND attendance.is_deleted = 0 LIMIT 20",
          "values": [
            "2143",
            "1679",
            "162",
            "851",
            "1355",
            "53",
            "453",
            "2024",
            "2096",
            "1049",
            "1871",
            "1902",
            "716",
            "1191",
            "1745",
            "390",
            "40",
            "699",
            "1793",
            "381"
          ]
        },
        {
          "field": "attendance.attend_date",
          "probe_sql": "SELECT DISTINCT attendance.attend_date AS value FROM attendance WHERE attendance.attend_date IS NOT NULL AND attendance.is_deleted = 0 LIMIT 20",
          "values": [
            "2025-09-25",
            "2025-09-07",
            "2025-09-10",
            "2025-09-18",
            "2025-09-23",
            "2025-09-08",
            "2025-09-22",
            "2025-09-27",
            "2025-09-05",
            "2025-09-03",
            "2025-09-21",
            "2025-09-02",
            "2025-09-28",
            "2025-09-12",
            "2025-09-24",
            "2025-09-11",
            "2025-09-20",
            "2025-09-04",
            "2025-09-15",
            "2025-09-26"
          ]
        },
        {
          "field": "student.is_deleted",
          "probe_sql": "SELECT DISTINCT student.is_deleted AS value FROM student WHERE student.is_deleted IS NOT NULL AND student.is_deleted = 0 LIMIT 20",
          "values": [
            "0"
          ]
        },
        {
          "field": "enroll.is_deleted",
          "probe_sql": "SELECT DISTINCT enroll.is_deleted AS value FROM enroll WHERE enroll.is_deleted IS NOT NULL AND enroll.is_deleted = 0 LIMIT 20",
          "values": [
            "0"
          ]
        },
        {
          "field": "course_class.is_deleted",
          "probe_sql": "SELECT DISTINCT course_class.is_deleted AS value FROM course_class WHERE course_class.is_deleted IS NOT NULL AND course_class.is_deleted = 0 LIMIT 20",
          "values": [
            "0"
          ]
        },
        {
          "field": "course.is_deleted",
          "probe_sql": "SELECT DISTINCT course.is_deleted AS value FROM course WHERE course.is_deleted IS NOT NULL AND course.is_deleted = 0 LIMIT 20",
          "values": [
            "0"
          ]
        },
        {
          "field": "attendance.is_deleted",
          "probe_sql": "SELECT DISTINCT attendance.is_deleted AS value FROM attendance WHERE attendance.is_deleted IS NOT NULL AND attendance.is_deleted = 0 LIMIT 20",
          "values": [
            "0"
          ]
        }
      ],
      "hints": [
        "error_type=execution_error",
        "use_probe_samples_to_rewrite_filters_or_entities",
        "retry_sql_generation_with_hidden_context"
      ],
      "kb_summary": {
        "table_count": 10,
        "field_count": 84
      },
      "retry_count": 2
    },
    "model_name": "qwen-max"
  },
  "output": {
    "sql": "WITH base AS (SELECT student.student_no, student.real_name, course.course_name, attendance.status FROM student JOIN enroll ON student.id = enroll.student_id JOIN course_class ON enroll.course_class_id = course_class.id JOIN course ON course_class.course_id = course.id JOIN attendance ON student.id = attendance.student_id AND course_class.id = attendance.course_class_id WHERE attendance.status IN ('缺勤', '迟到', '早退', '请假未批', '旷课') AND attendance.attend_date >= '2024-06-10' AND attendance.attend_date <= '2024-06-16' AND student.is_deleted = 0 AND enroll.is_deleted = 0 AND course_class.is_deleted = 0 AND course.is_deleted = 0 AND attendance.is_deleted = 0) SELECT base.student_no, base.real_name, base.course_name, base.status FROM base GROUP BY base.student_no, base.real_name, base.course_name, base.status",
    "entity_mappings": [
      {
        "type": "attendance_status",
        "value": "缺勤, 迟到, 早退, 请假未批, 旷课",
        "field": "attendance.status",
        "reason": "根据字段描述“出勤状态（出勤/缺勤/请假等）”映射"
      },
      {
        "type": "date_range",
        "value": "2024-06-10 - 2024-06-16",
        "field": "attendance.attend_date",
        "reason": "根据时间范围过滤条件映射"
      }
    ],
    "sql_fields": [
      "student.student_no",
      "student.real_name",
      "course.course_name",
      "attendance.status",
      "student.id",
      "enroll.student_id",
      "enroll.course_class_id",
      "course_class.id",
      "course_class.course_id",
      "course.id",
      "attendance.student_id",
      "attendance.course_class_id",
      "attendance.attend_date",
      "student.is_deleted",
      "enroll.is_deleted",
      "course_class.is_deleted",
      "course.is_deleted",
      "attendance.is_deleted",
      "base.student_no",
      "base.real_name",
      "base.course_name",
      "base.status"
    ],
    "applied_field_replacements": []
  }
}